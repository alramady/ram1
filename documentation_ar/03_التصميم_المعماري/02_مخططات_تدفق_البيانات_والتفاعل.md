# مخططات تدفق البيانات والتفاعل

يتتبع هذا المستند مسارات التنفيذ وتدفقات البيانات لخمس حالات استخدام أساسية لمنصة راصد الوطنية. يتم توضيح كل حالة استخدام بمخطط تسلسل Mermaid.js مصحوبًا بشرح مفصل للتفاعل بين مكونات النظام.

## 1. مصادقة المستخدم (تسجيل الدخول)

يوضح تدفق تسجيل الدخول آلية المصادقة القائمة على JWT، بما في ذلك حماية قفل الحساب بعد المحاولات الفاشلة.

```mermaid
sequenceDiagram
    participant U as المستخدم (المتصفح)
    participant R as تطبيق React
    participant T as عميل tRPC
    participant S as خادم tRPC
    participant M as برمجية المصادقة الوسيطة
    participant DB as MySQL/TiDB

    U->>R: إدخال بيانات الاعتماد (معرف المستخدم، كلمة المرور)
    R->>R: التحقق من جانب العميل (حقول غير فارغة)
    R->>T: تعديل auth.localLogin
    T->>S: POST /api/trpc/auth.localLogin
    S->>M: التحقق من حالة قفل الحساب
    M->>DB: SELECT failed_attempts, locked_until FROM users
    DB-->>M: حالة الحساب
    alt الحساب مقفل
        M-->>S: خطأ: الحساب مقفل (15 دقيقة)
        S-->>T: TRPCError (FORBIDDEN)
        T-->>R: استجابة خطأ
        R-->>U: عرض رسالة القفل
    else الحساب نشط
        M->>DB: SELECT user WHERE username = ?
        DB-->>M: سجل المستخدم
        M->>M: bcrypt.compare(password, hashedPassword)
        alt كلمة المرور متطابقة
            M->>M: إنشاء رمز JWT
            M->>DB: UPDATE lastSignedIn, reset failed_attempts
            M-->>S: { success: true, user: {...} }
            S-->>T: Set-Cookie: jwt=token (HttpOnly)
            T-->>R: استجابة نجاح مع بيانات المستخدم
            R->>R: تحديث ذاكرة التخزين المؤقت لـ React Query (auth.me)
            R-->>U: إعادة التوجيه إلى لوحة التحكم
        else كلمة المرور غير صحيحة
            M->>DB: INCREMENT failed_attempts
            alt failed_attempts >= 5
                M->>DB: SET locked_until = NOW() + 15min
            end
            M-->>S: خطأ: بيانات اعتماد غير صالحة
            S-->>T: TRPCError (UNAUTHORIZED)
            T-->>R: استجابة خطأ
            R-->>U: عرض رسالة خطأ
        end
    end
```

يبدأ تدفق المصادقة عندما يقدم المستخدم بيانات اعتماده من خلال مكون `LoginPage`. يقوم تطبيق React بإجراء تحقق أساسي من جانب العميل قبل إرسال تعديل `auth.localLogin` tRPC. على جانب الخادم، تتحقق برمجية المصادقة الوسيطة أولاً مما إذا كان الحساب مقفلاً حاليًا بسبب المحاولات الفاشلة المفرطة. إذا كان الحساب نشطًا، تسترد البرمجية الوسيطة سجل المستخدم من قاعدة البيانات وتقارن كلمة المرور المقدمة مقابل تجزئة bcrypt المخزنة. عند المصادقة الناجحة، يتم إنشاء رمز JWT وتعيينه كملف تعريف ارتباط HTTP-only، ويتم إعادة توجيه المستخدم إلى لوحة التحكم المناسبة لدوره.

## 2. سير عمل إنشاء المحتوى والموافقة عليه

توضح حالة الاستخدام هذه دورة الحياة الكاملة لمقال إخباري، من إنشائه بواسطة محرر مرورًا بموافقة مشرف المحتوى إلى النشر.

```mermaid
sequenceDiagram
    participant E as المحرر
    participant R as تطبيق React
    participant T as عميل tRPC
    participant S as خادم tRPC
    participant DB as MySQL/TiDB
    participant CDN as Manus CDN
    participant CM as مشرف المحتوى
    participant N as نظام الإشعارات

    E->>R: إنشاء مقال إخباري (RichTextEditor)
    E->>R: تحميل صورة الغلاف
    R->>CDN: تحميل ملف الصورة
    CDN-->>R: رابط الصورة (manuscdn.com/...)
    R->>T: تعديل news.create
    T->>S: POST /api/trpc/news.create
    S->>S: التحقق من صحة الإدخال (مخطط Zod)
    S->>S: التحقق من دور المستخدم (محرر+)
    S->>DB: INSERT INTO news (status=\'draft\', approvalStatus=\'pending\')
    DB-->>S: معرف المقال الجديد
    S->>T: تعديل approval.submitNews
    T->>S: POST /api/trpc/approval.submitNews
    S->>DB: UPDATE news SET submittedBy = editorId
    S->>N: إنشاء إشعار للمشرفين
    N->>DB: INSERT INTO notifications
    S-->>R: استجابة نجاح
    R-->>E: "تم تقديم المقال للموافقة"

    Note over CM: مشرف المحتوى يتلقى إشعارًا

    CM->>R: فتح قائمة انتظار الموافقة (/approval)
    R->>T: استعلام approval.pendingNews
    T->>S: GET /api/trpc/approval.pendingNews
    S->>DB: SELECT * FROM news WHERE approvalStatus=\'pending\'
    DB-->>S: قائمة المقالات المعلقة
    S-->>R: بيانات المقالات المعلقة
    R-->>CM: عرض المقالات المعلقة

    CM->>R: مراجعة والموافقة على المقال
    R->>T: تعديل approval.reviewNews
    T->>S: POST /api/trpc/approval.reviewNews
    S->>DB: UPDATE news SET approvalStatus=\'approved\', reviewedBy=moderatorId, isPublished=true
    S->>N: إعلام المحرر بالموافقة
    S-->>R: استجابة نجاح
    R-->>CM: "تمت الموافقة على المقال ونشره"
```

يوضح سير عمل إنشاء المحتوى عملية الموافقة متعددة الخطوات في المنصة. يستخدم المحرر محرر النصوص المنسقة `RichTextEditor` القائم على Tiptap لإنشاء مقال، وتحميل صورة غلاف إلى Manus CDN، وتقديم المقال للمراجعة. يتم تخزين المقال في قاعدة البيانات بحالة `draft` وحالة موافقة `pending`. يتم إرسال إشعار إلى مشرفي المحتوى، الذين يمكنهم مراجعة المقال من خلال صفحة قائمة انتظار الموافقة المخصصة. عند الموافقة، يتم تحديث حالة المقال إلى `approved` وتعيين `isPublished` إلى `true`، مما يجعله مرئيًا في قائمة الأخبار العامة.

## 3. تصفح المحتوى والتفاعل معه

توضح حالة الاستخدام هذه كيف يتصفح مستخدم عام محتوى الأخبار ويتفاعل معه من خلال الإشارات المرجعية والتعليقات.

```mermaid
sequenceDiagram
    participant U as المستخدم (المتصفح)
    participant R as تطبيق React
    participant RQ as ذاكرة التخزين المؤقت لـ React Query
    participant T as عميل tRPC
    participant S as خادم tRPC
    participant DB as MySQL/TiDB

    U->>R: الانتقال إلى /news
    R->>RQ: التحقق من ذاكرة التخزين المؤقت لـ news.list
    alt ذاكرة التخزين المؤقت فارغة أو قديمة
        RQ->>T: استعلام news.list
        T->>S: GET /api/trpc/news.list
        S->>DB: SELECT * FROM news WHERE isPublished=true ORDER BY sortOrder
        DB-->>S: قائمة الأخبار المنشورة
        S-->>T: بيانات الأخبار (مع تواريخ superjson)
        T-->>RQ: التخزين في ذاكرة التخزين المؤقت
    end
    RQ-->>R: بيانات قائمة الأخبار
    R-->>U: عرض بطاقات الأخبار مع الرسوم المتحركة

    U->>R: النقر على مقال إخباري
    R->>R: الانتقال إلى /news/:id (Wouter)
    R->>T: استعلام news.getById
    T->>S: GET /api/trpc/news.getById?input={id}
    S->>DB: SELECT * FROM news WHERE id=? AND isPublished=true
    DB-->>S: بيانات المقال
    S-->>R: المقال مع المحتوى الكامل
    R-->>U: عرض المقال مع ScrollProgressBar

    U->>R: النقر على زر الإشارة المرجعية
    R->>T: تعديل bookmarks.toggle
    T->>S: POST /api/trpc/bookmarks.toggle
    S->>DB: INSERT/DELETE FROM bookmarks
    DB-->>S: حالة الإشارة المرجعية المحدثة
    S-->>R: { isBookmarked: true }
    R->>RQ: إبطال صلاحية bookmarks.myBookmarks
    R-->>U: تحديث حالة BookmarkButton (أيقونة ممتلئة)
```

يستفيد تدفق تصفح المحتوى من آلية التخزين المؤقت في React Query لتحقيق الأداء الأمثل. عندما ينتقل المستخدم إلى قائمة الأخبار، يتحقق التطبيق أولاً من ذاكرة التخزين المؤقت المحلية للبيانات الموجودة. إذا كانت ذاكرة التخزين المؤقت فارغة أو قديمة، يتم إرسال استعلام جديد إلى خادم tRPC. يسترد الخادم المقالات المنشورة فقط، مرتبة حسب ترتيب الفرز المكون. عندما ينقر المستخدم على مقال، يتم تحميل عرض التفاصيل مع المحتوى الكامل، ويتتبع مكون `ScrollProgressBar` تقدم القراءة. تؤدي تفاعلات المستخدم مثل الإشارات المرجعية إلى تحديثات متفائلة لواجهة المستخدم تليها استمرارية من جانب الخادم.

## 4. مراجعة التحليلات الإدارية

توضح حالة الاستخدام هذه كيف يصل المسؤول ويراجع تحليلات المنصة.

```mermaid
sequenceDiagram
    participant A as المسؤول
    participant R as تطبيق React
    participant T as عميل tRPC
    participant S as خادم tRPC
    participant DB as MySQL/TiDB

    A->>R: الانتقال إلى /analytics
    R->>R: التحقق من دور المسؤول (فحص RBAC)
    
    par جلب البيانات بالتوازي
        R->>T: استعلام analytics.overview
        T->>S: GET /api/trpc/analytics.overview
        S->>DB: SELECT COUNT(*) FROM news, videos, images, ...
        DB-->>S: أعداد المحتوى
        S-->>R: { news: 18, videos: 6, images: 32, ... }
    and
        R->>T: استعلام analytics.activityByDay
        T->>S: GET /api/trpc/analytics.activityByDay
        S->>DB: SELECT date, COUNT(*) GROUP BY date
        DB-->>S: بيانات النشاط
        S-->>R: مصفوفة النشاط اليومي
    and
        R->>T: استعلام analytics.userRegistrations
        T->>S: GET /api/trpc/analytics.userRegistrations
        S->>DB: SELECT month, COUNT(*) FROM users GROUP BY month
        DB-->>S: بيانات التسجيل
        S-->>R: مصفوفة التسجيل الشهري
    and
        R->>T: استعلام analytics.topLiked
        T->>S: GET /api/trpc/analytics.topLiked
        S->>DB: SELECT content, like_count ORDER BY like_count DESC
        DB-->>S: المحتوى الأكثر إعجابًا
        S-->>R: العناصر الأكثر إعجابًا
    end

    R->>R: عرض تصورات Recharts
    R-->>A: عرض لوحة معلومات التحليلات

    A->>R: النقر على "إنشاء تقرير"
    R->>T: تعديل analytics.generateReport
    T->>S: POST /api/trpc/analytics.generateReport
    S->>S: تجميع بيانات التحليلات في تقرير
    S-->>R: بيانات التقرير
    R->>R: إنشاء PDF (PdfReportButton)
    R-->>A: تنزيل تقرير PDF
```

توضح لوحة معلومات التحليلات جلب البيانات بالتوازي، حيث يتم إرسال استعلامات tRPC متعددة في وقت واحد لملء أقسام مختلفة من لوحة المعلومات. يدير React Query هذه الطلبات المتوازية بكفاءة، ويعرض كل مخطط عند توفر بياناته. تعرض مكتبة `Recharts` البيانات كتصورات تفاعلية. يمكن للمسؤولين إنشاء تقارير PDF شاملة باستخدام مكون `PdfReportButton`.

## 5. المراسلة الداخلية

توضح حالة الاستخدام هذه نظام المراسلة الداخلي، بما في ذلك المراسلة المباشرة ووظيفة البث.

```mermaid
sequenceDiagram
    participant S as المرسل (المسؤول)
    participant R as تطبيق React
    participant T as عميل tRPC
    participant SV as خادم tRPC
    participant DB as MySQL/TiDB
    participant NS as نظام الإشعارات
    participant RC as المستلم

    S->>R: الانتقال إلى /messages
    R->>T: استعلام messages.users
    T->>SV: GET /api/trpc/messages.users
    SV->>DB: SELECT id, name, displayName FROM users
    DB-->>SV: قائمة المستخدمين
    SV-->>R: المستلمون المتاحون
    R-->>S: عرض نموذج الإنشاء مع قائمة المستخدمين

    S->>R: إنشاء وإرسال رسالة
    R->>T: تعديل messages.send
    T->>SV: POST /api/trpc/messages.send
    SV->>SV: التحقق من صحة الإدخال (Zod)
    SV->>DB: INSERT INTO messages (senderId, recipientId, content)
    SV->>NS: إنشاء إشعار للمستلم
    NS->>DB: INSERT INTO notifications (userId=recipientId, type=\'message\')
    SV-->>R: استجابة نجاح
    R->>R: إبطال صلاحية ذاكرة التخزين المؤقت لـ messages.sent
    R-->>S: "تم إرسال الرسالة بنجاح" (إشعار Sonner)

    Note over RC: المستلم يتلقى إشعارًا في الوقت الفعلي

    RC->>R: NotificationBell يعرض عدد غير مقروء
    R->>T: استعلام notifications.unreadCount (استقصاء)
    T->>SV: GET /api/trpc/notifications.unreadCount
    SV->>DB: SELECT COUNT(*) FROM notifications WHERE read=false
    SV-->>R: عدد غير مقروء
    R-->>RC: تحديث شارة NotificationBell

    RC->>R: الانتقال إلى /messages
    R->>T: استعلام messages.inbox
    T->>SV: GET /api/trpc/messages.inbox
    SV->>DB: SELECT * FROM messages WHERE recipientId=?
    SV-->>R: رسائل صندوق الوارد
    R-->>RC: عرض صندوق الوارد مع رسالة جديدة

    RC->>R: فتح وقراءة الرسالة
    R->>T: تعديل messages.markRead
    T->>SV: POST /api/trpc/messages.markRead
    SV->>DB: UPDATE messages SET read=true WHERE id=?
    R->>R: إبطال صلاحية ذاكرة التخزين المؤقت لـ messages.unreadCount
```

يوفر نظام المراسلة إمكانيات اتصال مباشر وبث. عندما يقوم مسؤول بإنشاء رسالة، يملأ استعلام `messages.users` محدد المستلم بجميع المستخدمين المسجلين. عند الإرسال، يتم الاحتفاظ بالرسالة في قاعدة البيانات ويتم إنشاء إشعار للمستلم. يستقصي مكون `NotificationBell` عن أعداد الإشعارات غير المقروءة، مما يوفر وعيًا شبه فوري بالرسائل الجديدة. قد يوفر مكون `RealtimeNotifications` أيضًا إشعارات فورية قائمة على WebSocket، على الرغم من أنه لا يمكن تأكيد ذلك بالكامل من خلال التحليل الثابت وحده.
