# تحليل نقاط الأداء الساخنة

يحدد هذا المستند الاختناقات المحتملة في الأداء في منصة راصد الوطنية، بناءً على تحليل بنية التطبيق وتصميم واجهة برمجة التطبيقات وأنماط العرض من جانب العميل. يتم تصنيف كل نقطة ساخنة حسب الخطورة ومرفقة بتوصيات للتخفيف.

## 1. نقاط الأداء الساخنة من جانب العميل

### 1.1. حجم الحزمة الأولية الكبير

**الخطورة:** متوسطة

يبلغ حجم حزمة JavaScript للإنتاج حوالي 2.1 ميغابايت (مصغرة). بينما يقوم Vite بتقسيم الكود، لا تزال الحزمة الأولية تتضمن العديد من المكتبات الثقيلة التي يتم تحميلها عند كل زيارة للصفحة.

| المكتبة | الحجم المقدر | تستخدم في |
|:---|:---|:---|
| Framer Motion | ~150 كيلوبايت | جميع الصفحات (PageTransition، الرسوم المتحركة) |
| Tiptap (محرر نصوص منسقة) | ~200 كيلوبايت | صفحات إنشاء المحتوى فقط |
| Recharts | ~180 كيلوبايت | صفحة التحليلات فقط |
| Radix UI (جميع البدائيات) | ~120 كيلوبايت | مكونات مختلفة |

**التوصية:** تنفيذ تقسيم الكود المستند إلى المسار باستخدام `React.lazy()` و `Suspense` لتأجيل تحميل Tiptap و Recharts حتى يتم الانتقال إلى صفحات كل منهما. ضع في اعتبارك استبدال Framer Motion برسوم CSS المتحركة للانتقالات البسيطة.

### 1.2. أداء الرسوم المتحركة للجسيمات

**الخطورة:** متوسطة

تستخدم مكونات `FloatingParticles` و `ParticleBackground` HTML5 Canvas مع حلقات `requestAnimationFrame` لعرض رسوم متحركة مستمرة للجسيمات. تعمل هذه الرسوم المتحركة على الخيط الرئيسي ويمكن أن تسبب انخفاضًا في الإطارات على الأجهزة ذات الطاقة المنخفضة، وخاصة الهواتف المحمولة.

**التوصية:** تنفيذ فحص الأداء عند تحميل المكون (على سبيل المثال، التحقق من `navigator.hardwareConcurrency`) وتقليل عدد الجسيمات أو تعطيل الرسوم المتحركة على الأجهزة ذات الطاقة المنخفضة. ضع في اعتبارك استخدام `OffscreenCanvas` مع Web Worker لمحاكاة الجسيمات.

### 1.3. تحميل الصور غير المحسن

**الخطورة:** متوسطة-عالية

يقوم معرض الصور (`GalleryPage`) بتحميل جميع الصور الـ 29+ في وقت واحد دون محاكاة افتراضية أو تحميل كسول. تؤدي كل بطاقة صورة إلى طلب شبكة للصورة ذات الدقة القياسية، مما قد يؤدي إلى استهلاك كبير لعرض النطاق الترددي وعرض أولي بطيء.

**التوصية:** تنفيذ تحميل كسول قائم على مراقب التقاطع لصور المعرض. استخدم حقل `imageUrlPreview` (الموجود في المخطط ولكن يبدو أنه غير مستغل بشكل كافٍ) لتحميل العناصر النائبة منخفضة الدقة أولاً. ضع في اعتبارك تنفيذ التمرير الافتراضي للمعارض التي تحتوي على أكثر من 50 صورة.

### 1.4. استقصاء React Query للإشعارات

**الخطورة:** منخفضة-متوسطة

يقوم مكون `NotificationBell` باستقصاء نقطة نهاية `notifications.unreadCount` على فترات منتظمة للتحقق من وجود إشعارات جديدة. يؤدي هذا إلى إنشاء حركة مرور مستمرة على الشبكة حتى عندما يكون المستخدم خاملاً.

**التوصية:** استبدال الاستقصاء بإشعارات الدفع المستندة إلى WebSocket (يشير مكون `RealtimeNotifications` إلى أن هذا قد يكون مطبقًا جزئيًا بالفعل). بدلاً من ذلك، قم بزيادة فترة الاستقصاء عندما لا تكون علامة تبويب المتصفح في بؤرة التركيز باستخدام حدث `visibilitychange`.

## 2. نقاط الأداء الساخنة في الواجهة الخلفية

### 2.1. استعلامات القائمة غير المصفاة

**الخطورة:** متوسطة

تعيد العديد من إجراءات استعلام tRPC (`news.all`, `videos.all`, `images.all`, `guides.all`, `links.all`) جميع السجلات دون ترقيم الصفحات. مع نمو مكتبة المحتوى، ستعيد هذه الاستعلامات حمولات أكبر بشكل متزايد.

| الإجراء | العدد الحالي | خطر النمو |
|:---|:---|:---|
| `news.all` | 18 عنصرًا | مرتفع (تتم إضافة الأخبار بشكل متكرر) |
| `images.all` | 32 عنصرًا | مرتفع (ينمو المعرض بمرور الوقت) |
| `guides.all` | 34 عنصرًا | متوسط |
| `links.all` | 34 عنصرًا | متوسط |
| `presentations.all` | 19 عنصرًا | متوسط |

**التوصية:** تنفيذ ترقيم الصفحات المستند إلى المؤشر أو الإزاحة لجميع استعلامات القائمة. أضف معلمات التصفية والفرز من جانب الخادم. ضع في اعتبارك تنفيذ التمرير اللانهائي في الواجهة الأمامية لتحميل المحتوى بشكل تدريجي.

### 2.2. استعلامات تجميع التحليلات

**الخطورة:** متوسطة

ترسل لوحة معلومات التحليلات (`AnalyticsPage`) من 6 إلى 9 استعلامات متوازية عند تحميل الصفحة، ومن المحتمل أن يقوم كل منها بتنفيذ عمليات SQL مجمعة (COUNT، GROUP BY) عبر مجموعة البيانات بأكملها. مع نمو قاعدة البيانات، ستصبح هذه الاستعلامات باهظة التكلفة بشكل متزايد.

**التوصية:** تنفيذ طرق عرض مجسدة أو جداول تحليلات محسوبة مسبقًا يتم تحديثها بشكل دوري (على سبيل المثال، عبر مهمة cron). قم بتخزين نتائج التحليلات مؤقتًا باستخدام TTL أطول لأنها لا تحتاج إلى دقة في الوقت الفعلي. ضع في اعتبارك تنفيذ عوامل تصفية نطاق التاريخ للحد من نطاق استعلامات التجميع.

### 2.3. تحديثات ترتيب المحتوى

**الخطورة:** منخفضة

تقبل طفرات `contentOrder.updateNewsOrder` و `contentOrder.updateVideosOrder` مصفوفة من جميع معرفات المحتوى بالترتيب المطلوب. يتطلب هذا تحديث عمود `sortOrder` لكل سجل في الجدول، حتى لو تغير موضع عنصر واحد فقط.

**التوصية:** تنفيذ خوارزمية ترتيب أكثر كفاءة تقوم بتحديث السجلات المتأثرة فقط. ضع في اعتبارك استخدام نظام ترتيب كسري (على سبيل المثال، تخزين ترتيب الفرز كعدد عشري) للسماح بالإدراج دون إعادة ترتيب جميع العناصر.

### 2.4. رسائل البث

**الخطورة:** منخفضة-متوسطة

ترسل طفرة `messages.broadcast` رسالة إلى جميع المستخدمين المسجلين. من المحتمل أن يؤدي هذا إلى إنشاء سجلات قاعدة بيانات N (واحد لكل مستلم) في معاملة واحدة، والتي يمكن أن تكون بطيئة وقد تسبب نزاعًا على قفل قاعدة البيانات مع نمو قاعدة المستخدمين.

**التوصية:** تنفيذ رسائل البث كسجل واحد مع علامة "بث"، بدلاً من إنشاء نسخ فردية لكل مستلم. بدلاً من ذلك، قم بمعالجة تسليم البث بشكل غير متزامن باستخدام قائمة انتظار مهام في الخلفية.

## 3. نقاط الأداء الساخنة في قاعدة البيانات

### 3.1. استعلامات أعمدة JSON

**الخطورة:** متوسطة

تستخدم العديد من الجداول أعمدة JSON (`allowedUserIds`) لتخزين مصفوفات من معرفات المستخدمين. يتطلب الاستعلام عن هذه الأعمدة لإجراء فحوصات التحكم في الوصول (على سبيل المثال، "هل لدى المستخدم X حق الوصول إلى هذا المحتوى؟") تحليل JSON في وقت الاستعلام، وهو أبطأ بكثير من عمليات البحث في الأعمدة المفهرسة.

**التوصية:** بالنسبة لأنماط التحكم في الوصول التي يتم الاستعلام عنها بشكل متكرر، ضع في اعتبارك إنشاء جدول تقاطع منفصل (على سبيل المثال، `content_user_access`) بمفاتيح خارجية مفهرسة. يتيح هذا استعلامات التحكم في الوصول المستندة إلى JOIN بكفاءة.

### 3.2. الفهارس المفقودة (مستنتجة)

**الخطورة:** متوسطة

بناءً على أنماط الاستعلام التي تمت ملاحظتها، من المحتمل أن تكون الفهارس التالية مطلوبة ولكنها قد لا تكون موجودة:

| الجدول | الفهرس المقترح | السبب |
|:---|:---|:---|
| `news` | `(isPublished, sortOrder)` | تحسين استعلام القائمة العامة |
| `news` | `(approvalStatus)` | تصفية قائمة انتظار الموافقة |
| `news` | `(authorId)` | تصفية المحتوى حسب المؤلف |
| `videos` | `(isPublished, sortOrder)` | تحسين استعلام القائمة العامة |
| `images` | `(isPublished, album)` | تصفية المعرض حسب الألبوم |
| `users` | `(role)` | استعلامات المستخدم المستندة إلى الأدوار |
| `users` | `(username)` | تحسين بحث تسجيل الدخول |

**التوصية:** مراجعة تعريفات مخطط Drizzle ORM وإضافة فهارس مركبة لأنماط الاستعلام الأكثر شيوعًا. استخدم `EXPLAIN ANALYZE` على استعلامات الإنتاج لتحديد الفهارس المفقودة.

## 4. أداء الشبكة

### 4.1. خدمة ملفات CDN

**الخطورة:** منخفضة

يتم تقديم جميع ملفات الوسائط من `files.manuscdn.com`، والذي يوفر التخزين المؤقت والتوزيع على مستوى CDN. ومع ذلك، لا يوجد دليل على تعيين رؤوس التخزين المؤقت من جانب العميل لاستجابات واجهة برمجة التطبيقات، مما يعني أن نتائج استعلام tRPC قد لا يتم تخزينها مؤقتًا بواسطة ذاكرة التخزين المؤقت HTTP للمتصفح.

**التوصية:** تكوين رؤوس `Cache-Control` المناسبة لاستجابات واجهة برمجة التطبيقات العامة (على سبيل المثال، يمكن تخزين `news.list` مؤقتًا لمدة 60 ثانية). تأكد من أن الملفات التي يتم تقديمها بواسطة CDN تتضمن رؤوس `ETag` و `Last-Modified` المناسبة للطلبات الشرطية.

### 4.2. الحمل الزائد لتسلسل SuperJSON

**الخطورة:** منخفضة

يضيف استخدام SuperJSON لتسلسل tRPC حملاً زائدًا صغيرًا على كل استجابة لواجهة برمجة التطبيقات، حيث يتضمن كائن `meta` يصف تحويلات النوع (على سبيل المثال، كائنات التاريخ). بالنسبة لاستجابات القائمة الكبيرة، يمكن أن تضيف هذه البيانات الوصفية حجم حمولة ملحوظًا.

**التوصية:** بالنسبة لنقاط النهاية الحرجة للأداء، ضع في اعتبارك استخدام تسلسل JSON القياسي مع تنسيق سلسلة تاريخ صريح، مما يلغي الحاجة إلى بيانات وصفية من نوع SuperJSON.

## 5. ملخص

| النقطة الساخنة | الخطورة | التأثير | جهد الإصلاح |
|:---|:---|:---|:---|
| حجم الحزمة الأولية الكبير | متوسطة | تحميل أول أبطأ | متوسط |
| رسوم الجسيمات المتحركة | متوسطة | انخفاض الإطارات على الهاتف المحمول | منخفض |
| تحميل الصور غير المحسن | متوسطة-عالية | إهدار عرض النطاق الترددي، معرض بطيء | منخفض |
| استقصاء الإشعارات | منخفضة-متوسطة | حركة مرور غير ضرورية على الشبكة | متوسط |
| استعلامات القائمة غير المصفاة | متوسطة | صفحات إدارية بطيئة مع نمو البيانات | متوسط |
| تجميع التحليلات | متوسطة | صفحة تحليلات بطيئة | مرتفع |
| استعلامات أعمدة JSON | متوسطة | فحوصات تحكم في الوصول بطيئة | مرتفع |
| فهارس قاعدة البيانات المفقودة | متوسطة | أداء استعلام دون المستوى الأمثل | منخفض |
