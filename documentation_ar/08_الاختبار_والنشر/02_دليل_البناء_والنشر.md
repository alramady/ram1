# دليل البناء والنشر

يقدم هذا المستند إرشادات شاملة لبناء وتكوين ونشر منصة راصد الوطنية. يعتمد الدليل على الهندسة العكسية للتطبيق المنشور وتكوين وقت التشغيل الخاص به.

## 1. المتطلبات الأساسية

### 1.1. البرامج المطلوبة

| البرنامج | الإصدار | الغرض |
|:---|:---|:---|
| **Node.js** | 22.x أو أحدث | وقت تشغيل JavaScript للخادم وأدوات البناء |
| **npm** أو **pnpm** | الأحدث | مدير الحزم لتثبيت الاعتماديات |
| **MySQL** أو **TiDB** | 8.x / 7.x | محرك قاعدة بيانات علائقية |
| **Git** | الأحدث | التحكم في الإصدار |

### 1.2. الحسابات والخدمات المطلوبة

| الخدمة | الغرض |
|:---|:---|
| **منصة Manus** | استضافة سحابية ونشر (هدف النشر الأساسي) |
| **Manus CDN** | تخزين الملفات لتحميلات الوسائط (الصور ومقاطع الفيديو والمستندات) |
| **خادم SMTP** | تسليم البريد الإلكتروني لإعادة تعيين كلمة المرور والتقارير الأسبوعية |

## 2. إعداد التطوير المحلي

### 2.1. استنساخ المستودع

```bash
git clone <repository-url>
cd rasid-platform
```

### 2.2. تثبيت الاعتماديات

```bash
npm install
# أو
pnpm install
```

### 2.3. تكوين متغيرات البيئة

أنشئ ملف `.env` في جذر المشروع بالمتغيرات التالية:

```env
# تكوين قاعدة البيانات
DATABASE_URL=mysql://username:password@localhost:3306/rasid_db

# المصادقة
JWT_SECRET=your-secure-jwt-secret-key-minimum-32-characters
SESSION_SECRET=your-secure-session-secret-key

# إعدادات التطبيق
APP_TITLE=منصة راصد الوطنية
APP_LOCALE=ar-SA
APP_DIRECTION=rtl

# تخزين الملفات (Manus CDN)
MANUS_CDN_URL=https://files.manuscdn.com

# تكوين SMTP (اختياري للتطوير المحلي)
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@example.com
SMTP_PASS=smtp-password
SMTP_FROM=noreply@example.com
SMTP_SECURE=false
```

### 2.4. تهيئة قاعدة البيانات

```bash
# إنشاء ترحيلات قاعدة البيانات من مخطط Drizzle
npx drizzle-kit generate

# تطبيق الترحيلات على قاعدة البيانات
npx drizzle-kit push

# (اختياري) ملء قاعدة البيانات بالبيانات الأولية
npm run db:seed
```

### 2.5. إنشاء المستخدم المسؤول

بعد تهيئة قاعدة البيانات، قم بإنشاء حساب المسؤول الجذر:

```bash
npm run create-admin -- \
  --username MRUHAILY \
  --password 15001500 \
  --name "Muhammed ALRuhaily" \
  --email prog.muhammed@gmail.com \
  --mobile +966553445533 \
  --displayName "Admin Rasid System"
```

بدلاً من ذلك، يمكن إنشاء المستخدم المسؤول مباشرة في قاعدة البيانات:

```sql
INSERT INTO users (openId, name, email, role, username, displayName, mobile, loginMethod, isActive)
VALUES (
'local_MRUHAILY', 'Muhammed ALRuhaily', 'prog.muhammed@gmail.com', 'admin', 'MRUHAILY', 'Admin Rasid System', '+966553445533', 'local', true);
```

### 2.6. بدء خادم التطوير

```bash
npm run dev
```

يبدأ هذا كلاً من خادم تطوير Vite (الواجهة الأمامية) وخادم tRPC (الواجهة الخلفية) مع تمكين استبدال الوحدة النمطية السريع. سيكون التطبيق متاحًا على `http://localhost:5000`.

## 3. بناء الإنتاج

### 3.1. بناء التطبيق

```bash
npm run build
```

يقوم هذا الأمر بما يلي:
1. تجميع ملفات مصدر TypeScript
2. تجميع الواجهة الأمامية React مع Vite (الإخراج إلى `dist/public/`)
3. تجميع الواجهة الخلفية Node.js (الإخراج إلى `dist/`)
4. إنشاء أصول إنتاج محسّنة مع تجزئة المحتوى

### 3.2. هيكل إخراج البناء

```
dist/
├── public/
│   ├── assets/
│   │   ├── index-CCVI1ym-.js      # حزمة التطبيق الرئيسية (~2.1 ميغابايت)
│   │   └── index-BxPuHNBZ.css     # أنماط TailwindCSS المجمعة
│   └── index.html                  # إدخال HTML مع تكوين وقت التشغيل
└── server.js                       # خادم الواجهة الخلفية المجمع
```

### 3.3. التحقق من البناء

```bash
npm run preview
```

يبدأ هذا خادم معاينة محليًا يخدم بناء الإنتاج.

## 4. النشر

### 4.1. نشر منصة Manus (الأساسي)

تم تصميم منصة راصد الوطنية للنشر على منصة Manus، والتي توفر:

- إدارة شهادات SSL/TLS التلقائية
- خدمة الأصول الثابتة المستندة إلى CDN
- اتصالات قاعدة بيانات مُدارة
- إدارة متغيرات البيئة
- عمليات نشر بدون توقف

**خطوات النشر:**

1. ربط مستودع Git بمنصة Manus
2. تكوين متغيرات البيئة في لوحة تحكم Manus
3. تعيين أمر البناء: `npm run build`
4. تعيين أمر البدء: `node dist/server.js`
5. تكوين المجال المخصص: `www.rasid.vip`
6. النشر

### 4.2. نشر Docker (بديل)

أنشئ `Dockerfile` للنشر في حاويات:

```dockerfile
FROM node:22-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:22-alpine AS runner
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./

EXPOSE 5000
ENV NODE_ENV=production
CMD ["node", "dist/server.js"]
```

البناء والتشغيل:

```bash
docker build -t rasid-platform .
docker run -p 5000:5000 --env-file .env rasid-platform
```

### 4.3. تكوين الوكيل العكسي (Nginx)

لعمليات نشر الإنتاج خلف Nginx:

```nginx
server {
    listen 80;
    server_name www.rasid.vip rasid.vip;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.rasid.vip;

    ssl_certificate /etc/ssl/certs/rasid.vip.crt;
    ssl_certificate_key /etc/ssl/private/rasid.vip.key;

    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /assets/ {
        proxy_pass http://localhost:5000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

## 5. إدارة قاعدة البيانات

### 5.1. الترحيلات

```bash
# إنشاء ترحيل جديد بعد تغييرات المخطط
npx drizzle-kit generate

# تطبيق الترحيلات المعلقة
npx drizzle-kit push

# عرض حالة الترحيل
npx drizzle-kit status

# فتح Drizzle Studio لفحص قاعدة البيانات
npx drizzle-kit studio
```

### 5.2. النسخ الاحتياطي والاستعادة

```bash
# النسخ الاحتياطي
mysqldump -u username -p rasid_db > backup_$(date +%Y%m%d).sql

# الاستعادة
mysql -u username -p rasid_db < backup_20260213.sql
```

## 6. التحقق بعد النشر

بعد النشر، تحقق مما يلي:

| التحقق | الطريقة | النتيجة المتوقعة |
|:---|:---|:---|
| تحميل الصفحة الرئيسية | زيارة `https://www.rasid.vip/` | صفحة الهبوط مع أحدث محتوى |
| استجابة واجهة برمجة التطبيقات | `curl https://www.rasid.vip/api/trpc/news.list` | استجابة JSON مع بيانات الأخبار |
| عمل المصادقة | تسجيل الدخول ببيانات اعتماد المسؤول | إعادة التوجيه إلى لوحة تحكم المسؤول |
| إمكانية الوصول إلى ملفات CDN | التحقق من عناوين URL للصور في المقالات الإخبارية | تحميل الصور من manuscdn.com |
| تكوين SMTP | إرسال بريد إلكتروني اختباري من `/smtp-settings` | استلام البريد الإلكتروني على عنوان الاختبار |
| صلاحية شهادة SSL | التحقق من أيقونة القفل في المتصفح | شهادة صالحة لـ rasid.vip |

## 7. المراقبة والصيانة

### 7.1. فحوصات السلامة

مراقبة نقاط النهاية التالية:

- `GET /api/trpc/news.list` — يتحقق من اتصال واجهة برمجة التطبيقات وقاعدة البيانات
- `GET /` — يتحقق من خدمة الواجهة الأمامية

### 7.2. إدارة السجلات

يتم إخراج سجلات التطبيق إلى stdout/stderr ويمكن التقاطها بواسطة نظام إدارة السجلات لمنصة الاستضافة. أحداث السجل الرئيسية التي يجب مراقبتها:

- فشل المصادقة (هجمات القوة الغاشمة المحتملة)
- أخطاء اتصال قاعدة البيانات
- فشل تسليم SMTP
- استثناءات غير معالجة

### 7.3. مهام الصيانة الدورية

| المهمة | التكرار | الوصف |
|:---|:---|:---|
| النسخ الاحتياطي لقاعدة البيانات | يوميًا | نسخ احتياطي آلي لقاعدة بيانات MySQL/TiDB |
| تحديثات الاعتماديات | شهريًا | مراجعة وتحديث اعتماديات npm |
| تدقيق الأمان | ربع سنوي | تشغيل `npm audit` ومراجعة النتائج |
| مراجعة الأداء | ربع سنوي | مراجعة التحليلات وتحديد الاختناقات |
| تجديد شهادة SSL | قبل انتهاء الصلاحية | تجديد شهادة SSL (تلقائي مع Let's Encrypt) |
