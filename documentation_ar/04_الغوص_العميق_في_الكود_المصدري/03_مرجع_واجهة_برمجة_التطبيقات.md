# مرجع واجهة برمجة التطبيقات (API)

تعرض منصة راصد الوطنية واجهة برمجة التطبيقات الخاصة بها من خلال tRPC (TypeScript Remote Procedure Call)، والذي يوفر أمانًا شاملاً للأنواع بين العميل والخادم. على عكس واجهات برمجة تطبيقات REST التقليدية، يتم استدعاء إجراءات tRPC كاستدعاءات دالات مكتوبة بدلاً من نقاط نهاية HTTP. ومع ذلك، يمكن الوصول إليها عبر HTTP على المسار الأساسي `/api/trpc/{router}.{procedure}`.

## 1. نظرة عامة على واجهة برمجة التطبيقات

| الخاصية | القيمة |
|:---|:---|
| **عنوان URL الأساسي** | `https://www.rasid.vip/api/trpc` |
| **البروتوكول** | tRPC عبر HTTP |
| **التسلسل** | SuperJSON (يحافظ على أنواع Date, Map, Set) |
| **المصادقة** | JWT عبر ملفات تعريف ارتباط HTTP-only |
| **طريقة الاستعلام** | `GET /api/trpc/{procedure}?input={encoded_json}` |
| **طريقة التعديل** | `POST /api/trpc/{procedure}` مع نص JSON `{"json": {...}}` |

## 2. موجه المصادقة (`auth`)

### 2.1. auth.me (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع ملف تعريف المستخدم المصادق عليه حاليًا |
| **المصادقة** | مطلوبة (ملف تعريف ارتباط JWT) |
| **الإدخال** | لا شيء |
| **استجابة النجاح (200)** | `{ id, openId, name, email, role, username, displayName, mobile, title, avatarUrl, loginMethod, createdAt, updatedAt, lastSignedIn }` |
| **استجابة الخطأ (401)** | `{ code: "UNAUTHORIZED", message: "Not authenticated" }` |

### 2.2. auth.localLogin (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يصادق على مستخدم باستخدام اسم المستخدم وكلمة المرور |
| **المصادقة** | غير مطلوبة |
| **الإدخال** | `{ username: string, password: string }` |
| **استجابة النجاح (200)** | `{ success: true, user: { id, name, displayName, role, username } }` + رأس Set-Cookie |
| **استجابات الخطأ** | `UNAUTHORIZED` (بيانات اعتماد غير صالحة)، `FORBIDDEN` (حساب مقفل)، `BAD_REQUEST` (حقول مفقودة) |

### 2.3. auth.logout (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يسجل خروج المستخدم الحالي عن طريق مسح ملف تعريف ارتباط JWT |
| **المصادقة** | مطلوبة |
| **الإدخال** | لا شيء |
| **استجابة النجاح (200)** | `{ success: true }` |

### 2.4. auth.changePassword (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يغير كلمة مرور المستخدم المصادق عليه |
| **المصادقة** | مطلوبة |
| **الإدخال** | `{ currentPassword: string, newPassword: string }` |
| **استجابة النجاح (200)** | `{ success: true }` |
| **استجابات الخطأ** | `UNAUTHORIZED` (كلمة مرور حالية خاطئة)، `BAD_REQUEST` (كلمة مرور ضعيفة) |

### 2.5. auth.requestPasswordReset (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يرسل بريدًا إلكترونيًا لإعادة تعيين كلمة المرور إلى العنوان المحدد |
| **المصادقة** | غير مطلوبة |
| **الإدخال** | `{ email: string }` |
| **استجابة النجاح (200)** | `{ success: true }` |

### 2.6. auth.resetPassword (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يعيد تعيين كلمة مرور المستخدم باستخدام رمز إعادة التعيين |
| **المصادقة** | غير مطلوبة |
| **الإدخال** | `{ token: string, newPassword: string }` |
| **استجابة النجاح (200)** | `{ success: true }` |

### 2.7. auth.updateProfile (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يحدث معلومات ملف تعريف المستخدم المصادق عليه |
| **المصادقة** | مطلوبة |
| **الإدخال** | `{ name?: string, displayName?: string, mobile?: string, title?: string }` |
| **استجابة النجاح (200)** | كائن المستخدم المحدث |

### 2.8. auth.uploadAvatar (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يحمل صورة رمزية جديدة للمستخدم المصادق عليه |
| **المصادقة** | مطلوبة |
| **الإدخال** | `{ imageData: string }` (مشفر base64) |
| **استجابة النجاح (200)** | `{ avatarUrl: string }` |

## 3. موجه الأخبار (`news`)

### 3.1. news.list (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع المقالات الإخبارية المنشورة، مرتبة حسب sortOrder |
| **المصادقة** | غير مطلوبة |
| **الإدخال** | لا شيء |
| **استجابة النجاح (200)** | مصفوفة من كائنات الأخبار (المنشورة فقط، لوحظ 15 عنصرًا) |
| **الأذونات** | وصول عام؛ يتم إرجاع المقالات التي تحمل `isPublished=true` فقط |

### 3.2. news.all (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع جميع المقالات الإخبارية بما في ذلك المسودات وغير المنشورة |
| **المصادقة** | مطلوبة (مسؤول/محرر) |
| **الإدخال** | لا شيء |
| **استجابة النجاح (200)** | مصفوفة من جميع كائنات الأخبار (لوحظ 18 عنصرًا) |
| **الأذونات** | يتطلب دور المسؤول أو المحرر |

### 3.3. news.latest (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع أحدث مقال إخباري منشور |
| **المصادقة** | غير مطلوبة |
| **الإدخال** | لا شيء |
| **استجابة النجاح (200)** | مصفوفة مع كائن أخبار واحد |

### 3.4. news.getById (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع مقالًا إخباريًا محددًا حسب المعرف |
| **المصادقة** | غير مطلوبة (المقالات العامة)؛ مطلوبة (غير المنشورة) |
| **الإدخال** | `{ id: number }` |
| **استجابة النجاح (200)** | كائن أخبار واحد |
| **استجابة الخطأ (404)** | `{ code: "NOT_FOUND" }` |

### 3.5. news.create (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | ينشئ مقالًا إخباريًا جديدًا |
| **المصادقة** | مطلوبة (محرر+) |
| **الإدخال** | `{ title: string, content: string, summary?: string, imageUrl?: string, category?: string, visibility?: string, allowedUserIds?: number[] }` |
| **استجابة النجاح (200)** | كائن الأخبار الذي تم إنشاؤه مع معرف تم إنشاؤه |

### 3.6. news.update (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يحدث مقالًا إخباريًا موجودًا |
| **المصادقة** | مطلوبة (محرر+ أو المؤلف) |
| **الإدخال** | `{ id: number, title?: string, content?: string, summary?: string, imageUrl?: string, category?: string, isPublished?: boolean, visibility?: string }` |
| **استجابة النجاح (200)** | كائن الأخبار المحدث |

### 3.7. news.delete (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يحذف مقالًا إخباريًا |
| **المصادقة** | مطلوبة (مسؤول) |
| **الإدخال** | `{ id: number }` |
| **استجابة النجاح (200)** | `{ success: true }` |

## 4. موجه مقاطع الفيديو (`videos`)

### 4.1. videos.list / videos.all (استعلامات)

اتبع نفس نمط `news.list` / `news.all` مع حقول خاصة بالفيديو.

### 4.2. videos.create (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الإدخال** | `{ title: string, description?: string, videoUrl: string, videoUrlHd?: string, thumbnailUrl?: string, duration?: string, category?: string, visibility?: string, allowDownload?: boolean, allowPlay?: boolean, allowHdDownload?: boolean }` |

### 4.3. videos.update / videos.delete (تعديلات)

اتبع نفس نمط تعديلات الأخبار.

## 5. موجه الصور (`images`)

### 5.1. images.list / images.all (استعلامات)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع الصور المنشورة/الكلية مع بيانات وصفية للمعرض |
| **حقول الاستجابة** | `id, title, description, imageUrl, imageUrlHd, imageUrlPreview, album, fileSize, mimeType, width, height, isPublished, visibility, allowedUserIds, allowDownload, allowHdDownload, authorId, createdAt` |

### 5.2. images.create / images.update / images.delete (تعديلات)

اتبع أنماط CRUD القياسية مع حقول خاصة بالصور.

## 6. موجه الأدلة (`guides`)

### 6.1. guides.list / guides.all (استعلامات)

| الخاصية | القيمة |
|:---|:---|
| **حقول الاستجابة** | `id, title, description, fileUrl, fileType, guideType, category, isPublished, visibility, allowedUserIds, allowDownload, authorId, createdAt` |

## 7. موجه العروض التقديمية (`presentations`)

### 7.1. presentations.list / presentations.all / presentations.getById (استعلامات)

| الخاصية | القيمة |
|:---|:---|
| **حقول الاستجابة** | `id, title, description, fileUrl, thumbnailUrl, slideCount, category, isPublished, isMemberOnly, visibility, allowedUserIds, allowDownload, authorId, createdAt` |

## 8. موجه الروابط (`links`)

### 8.1. links.list / links.all (استعلامات)

| الخاصية | القيمة |
|:---|:---|
| **حقول الاستجابة** | `id, title, description, url, icon, category, sortOrder, isPublished, visibility, allowedUserIds, createdAt` |

## 9. موجه سجل الزوار (`guestbook`)

### 9.1. guestbook.list (استعلام) — إدخالات عامة معتمدة
### 9.2. guestbook.all (استعلام) — جميع الإدخالات بما في ذلك غير المعتمدة (مسؤول)
### 9.3. guestbook.create (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الإدخال** | `{ name: string, email?: string, message: string, organization?: string }` |

### 9.4. guestbook.approve (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الإدخال** | `{ id: number }` |
| **الأذونات** | يتطلب دور المسؤول |

## 10. موجه العلامات (`tags`)

### 10.1. tags.list (استعلام) — يُرجع جميع العلامات
### 10.2. tags.getContentByTag (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الإدخال** | `{ tagId: number }` أو `{ tagName: string }` |
| **الاستجابة** | عناصر المحتوى المرتبطة بالعلامة المحددة |

### 10.3. tags.create / tags.update / tags.delete (تعديلات)

CRUD قياسي مع إدخال `{ name: string, color?: string }`.

## 11. موجه المستخدمين (`users`)

### 11.1. users.list (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع جميع المستخدمين المسجلين |
| **المصادقة** | مطلوبة (مسؤول) |
| **حقول الاستجابة** | `id, name, email, role, username, displayName, mobile, title, avatarUrl, isActive, createdAt, lastSignedIn` |

### 11.2. users.update (تعديل)

| الخاصية | القيمة |
|:---|:---|
| **الإدخال** | `{ id: number, role?: string, isActive?: boolean, displayName?: string }` |
| **الأذونات** | يتطلب دور المسؤول |

## 12. موجه التحليلات (`analytics`)

### 12.1. analytics.overview (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الاستجابة** | `{ news: number, videos: number, images: number, guides: number, presentations: number, links: number, users: number, comments: number, likes: number, messages: number }` |

### 12.2. analytics.activityByDay (استعلام)

يُرجع أعداد النشاط اليومي كمصفوفة من `{ date: string, count: number }`.

### 12.3. analytics.userRegistrations (استعلام)

يُرجع أعداد التسجيل الشهرية.

### 12.4. analytics.topLiked / analytics.recentActivity / analytics.bookmarksByType / analytics.commentsByMonth / analytics.contentByMonth / analytics.likesByType (استعلامات)

يُرجع كل منها بيانات تحليلية مجمعة بتنسيقاتها الخاصة.

### 12.5. analytics.generateReport (تعديل)

ينشئ تقريرًا تحليليًا شاملاً للتنزيل.

## 13. موجه لوحة التحكم (`dashboard`)

### 13.1. dashboard.stats (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الاستجابة** | `{ newsCount: 18, videosCount: 6, imagesCount: 32, guidesCount: 34, presentationsCount: 19, guestbookCount: 5, usersCount: 9, linksCount: 34, memberFilesCount: 5 }` |

## 14. موجه الموافقة (`approval`)

### 14.1. approval.pendingNews / approval.pendingVideos (استعلامات)

يُرجع عناصر المحتوى التي تحمل `approvalStatus=\'pending\'`.

### 14.2. approval.mySubmissions (استعلام)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يُرجع المحتوى الذي قدمه المستخدم الحالي للموافقة |
| **المصادقة** | مطلوبة (محرر+) |
| **الاستجابة** | مصفوفة من عناصر الأخبار ومقاطع الفيديو |

### 14.3. approval.submitNews / approval.submitVideo (تعديلات)

يُقدم محتوى للموافقة، ويغير `approvalStatus` إلى `pending`.

### 14.4. approval.reviewNews / approval.reviewVideo (تعديلات)

| الخاصية | القيمة |
|:---|:---|
| **الوصف** | يوافق على أو يرفض محتوى معلقًا |
| **الإدخال** | `{ id: number, approved: boolean, reviewNote?: string }` |
| **الأذونات** | يتطلب دور مشرف المحتوى أو المسؤول |
